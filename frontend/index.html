<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebChatQQ</title>
    <!-- å¼•å…¥Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥Pico CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">
    <style>
        :root {
            --primary-color: #00aaff;
            --primary-light: #80d4ff;
            --primary-dark: #0088cc;
            --secondary-color: #f0f0f0;
            --text-color: #333333;
            --text-light: #777777;
            --border-color: #dddddd;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ç™»å½•ç•Œé¢æ ·å¼ */
        #login {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #login h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        #join-button {
            width: 100%;
            background-color: var(--primary-color);
            border: none;
            margin-top: 1rem;
        }

        #join-button:hover {
            background-color: var(--primary-dark);
        }

        /* èŠå¤©ç•Œé¢æ ·å¼ */
        #chat {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: white;
        }

        #chat-header {
            padding: 1rem;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #sidebar {
            width: 250px;
            background-color: var(--secondary-color);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            overflow-y: auto;
        }

        #member-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #member-list li {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        #member-list li .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-light);
            margin-right: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-dark);
        }

        #chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
        }

        .message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-light);
            margin-right: 0.75rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .message .content {
            flex: 1;
        }

        .message .sender {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .message .sender .badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.75rem;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .message .text {
            background-color: var(--secondary-color);
            padding: 0.75rem;
            border-radius: 8px;
            display: inline-block;
            max-width: 70%;
        }

        .message.self {
            flex-direction: row-reverse;
        }

        .message.self .avatar {
            margin-right: 0;
            margin-left: 0.75rem;
        }

        .message.self .sender {
            text-align: right;
        }

        .message.self .text {
            background-color: var(--primary-light);
            text-align: right;
        }

        .system-message {
            text-align: center;
            color: var(--text-light);
            font-style: italic;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        #input-area {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        #message-input {
            flex: 1;
            margin-right: 1rem;
        }

        #status-bar {
            padding: 0.5rem 1rem;
            background-color: var(--secondary-color);
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
        }

        .connection-status {
            display: flex;
            align-items: center;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-dot.connected {
            background-color: var(--success-color);
        }

        .status-dot.connecting {
            background-color: var(--warning-color);
        }

        .status-dot.disconnected {
            background-color: var(--danger-color);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            #sidebar {
                display: none;
            }
            
            #login {
                margin: 1rem;
                padding: 1.5rem;
            }
        }

        /* å·¥å…·ç±» */
        .hidden {
            display: none !important;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
}

.modal button {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #fff;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 20px;
    cursor: pointer;
}

/* æ¶ˆæ¯å›¾ç‰‡æ ·å¼ */
.message-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s;
}

.message-image:hover {
    transform: scale(1.02);
}

/* è®¾ç½®æ¨¡æ€æ¡†æ ·å¼ */
.setting-group {
    margin-bottom: 1rem;
}

.setting-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.setting-group input[type="text"] {
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
}

.setting-group input[type="checkbox"] {
    margin-right: 0.5rem;
}

/* è®¾ç½®æŒ‰é’®æ ·å¼ */
#settings-btn {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.5rem;
}

#settings-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

/* è¡¨æƒ…æ ·å¼ */
.face {
    display: inline-block;
    background-color: #f0f0f0;
    padding: 2px 4px;
    border-radius: 4px;
    margin: 0 2px;
}

/* æˆå‘˜åˆ—è¡¨æ ·å¼ */
.member-info {
    flex: 1;
}

.member-name {
    font-weight: 500;
}

.member-title {
    font-size: 0.8rem;
    color: var(--text-light);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    #sidebar {
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        z-index: 100;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }
    
    #sidebar:not(.hidden) {
        transform: translateX(0);
    }
    
    .message .text {
        max-width: 85% !important;
    }
    
    .message-image {
        max-width: 200px;
        max-height: 200px;
    }
}

/* åŠ¨ç”»æ•ˆæœ */
.message {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.status-dot {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.status-dot.connected {
    animation: none;
    opacity: 1;
}
    </style>
</head>
<body>
    <div id="app">
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="login">
            <h2>åŠ å…¥ç¾¤èŠ</h2>
            <div class="input-group">
                <label for="nickname">ä½ çš„æ˜µç§°</label>
                <input type="text" id="nickname" placeholder="è¾“å…¥ä½ çš„æ˜µç§°" autocomplete="nickname">
            </div>
            <div class="input-group">
                <label for="group-id">QQç¾¤å·</label>
                <input type="text" id="group-id" placeholder="è¾“å…¥QQç¾¤å·">
            </div>
            <div class="input-group">
                <label for="password">å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                <input type="password" id="password" placeholder="è¾“å…¥å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰">
            </div>
            <button id="join-button" class="primary">åŠ å…¥ç¾¤èŠ</button>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div id="chat" class="hidden">
            <header id="chat-header">
                <h3>ç¾¤èŠåç§°</h3>
                <button id="sidebar-toggle" class="secondary outline">æˆå‘˜åˆ—è¡¨</button>
            </header>
            
            <div id="chat-main">
                <aside id="sidebar">
                    <h4>ç¾¤æˆå‘˜</h4>
                    <ul id="member-list">
                        <!-- æˆå‘˜åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </ul>
                </aside>
                
                <div id="chat-content">
                    <div id="messages">
                        <!-- æ¶ˆæ¯å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div id="input-area">
                        <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                        <button id="send-button">å‘é€</button>
                    </div>
                </div>
            </div>
            
            <footer id="status-bar">
                <div class="connection-status">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="status-text">æœªè¿æ¥</span>
                </div>
                <div id="online-count">åœ¨çº¿: 0</div>
            </footer>
        </div>
    </div>

        <script>
// Vue 3 åº”ç”¨å®ä¾‹
const { createApp, ref, reactive, onMounted, onUnmounted } = Vue;

// å·¥å…·å‡½æ•°
const utils = {
    // ç”ŸæˆéšæœºID
    generateId: () => Math.random().toString(36).substring(2, 15),
    
    // æ ¼å¼åŒ–æ—¶é—´
    formatTime: (timestamp) => {
        const date = new Date(timestamp);
        return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    },
    
    // è·å–åç§°é¦–å­—æ¯ï¼ˆç”¨äºå¤´åƒï¼‰
    getInitials: (name) => {
        if (!name) return '?';
        const parts = name.split(' ');
        if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
        return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    },
    
    // è§£æCQç 
    parseCQCode: (message) => {
        if (typeof message !== 'string') return [{ type: 'text', data: { text: String(message) } }];
        
        const result = [];
        let textBuffer = '';
        let i = 0;
        
        while (i < message.length) {
            if (message.substring(i, i + 4) === '[CQ:') {
                // å¤„ç†æ–‡æœ¬ç¼“å†²åŒº
                if (textBuffer) {
                    result.push({ type: 'text', data: { text: textBuffer } });
                    textBuffer = '';
                }
                
                // æ‰¾åˆ°CQç ç»“æŸä½ç½®
                const endIndex = message.indexOf(']', i);
                if (endIndex === -1) {
                    textBuffer += message.substring(i);
                    break;
                }
                
                // è§£æCQç 
                const cqCode = message.substring(i + 4, endIndex);
                const sepIndex = cqCode.indexOf(',');
                const cqType = sepIndex === -1 ? cqCode : cqCode.substring(0, sepIndex);
                
                const cqData = {};
                if (sepIndex !== -1) {
                    const params = cqCode.substring(sepIndex + 1).split(',');
                    params.forEach(param => {
                        const eqIndex = param.indexOf('=');
                        if (eqIndex !== -1) {
                            const key = param.substring(0, eqIndex);
                            const value = param.substring(eqIndex + 1);
                            cqData[key] = value;
                        }
                    });
                }
                
                result.push({ type: cqType, data: cqData });
                i = endIndex + 1;
            } else {
                textBuffer += message[i];
                i++;
            }
        }
        
        // å¤„ç†å‰©ä½™çš„æ–‡æœ¬
        if (textBuffer) {
            result.push({ type: 'text', data: { text: textBuffer } });
        }
        
        return result;
    },
    
    // æ„å»ºCQç 
    buildCQCode: (type, data) => {
        let code = `[CQ:${type}`;
        for (const key in data) {
            if (data[key]) {
                code += `,${key}=${data[key]}`;
            }
        }
        code += ']';
        return code;
    },
    uploadImage: async (file, apiUrl) => {
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch(`${apiUrl}/upload_file`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            if (result.status === 'ok') {
                return result.data.file;
            } else {
                throw new Error(result.msg || 'ä¸Šä¼ å¤±è´¥');
            }
        } catch (error) {
            console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
            throw error;
        }
    },
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡æ–‡ä»¶
    isImageFile: (file) => {
        return file.type.startsWith('image/');
    }
};

// åœ¨ Vue setup å‡½æ•°ä¸­æ·»åŠ å›¾ç‰‡ä¸Šä¼ ç›¸å…³ä»£ç 

// æ’¤å›æ¶ˆæ¯
const recallMessage = async (messageId) => {
    try {
        const response = await fetch(`${state.config.apiUrl}/delete_msg`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message_id: parseInt(messageId)
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'ok') {
            addSystemMessage('æ¶ˆæ¯å·²æ’¤å›');
            
            // ä»æ¶ˆæ¯åˆ—è¡¨ä¸­ç§»é™¤è¢«æ’¤å›çš„æ¶ˆæ¯
            state.messages = state.messages.filter(msg => msg.id !== messageId);
            updateMessagesDisplay();
        } else {
            console.error('æ’¤å›æ¶ˆæ¯å¤±è´¥:', result);
            addSystemMessage('æ’¤å›æ¶ˆæ¯å¤±è´¥: ' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('æ’¤å›æ¶ˆæ¯æ—¶å‡ºé”™:', error);
        addSystemMessage('æ’¤å›æ¶ˆæ¯æ—¶å‡ºé”™: ' + error.message);
    }
};

// åœ¨æ¸²æŸ“æ¶ˆæ¯æ—¶æ·»åŠ æ’¤å›æŒ‰é’®ï¼ˆä»…å¯¹è‡ªå·±çš„æ¶ˆæ¯ï¼‰
const renderMessage = (message) => {
    // ... å·²æœ‰çš„æ¸²æŸ“ä»£ç 
    
    // å¦‚æœæ˜¯è‡ªå·±çš„æ¶ˆæ¯ï¼Œæ·»åŠ æ’¤å›æŒ‰é’®
    if (message.sender && message.sender.user_id === state.currentUser.id) {
        const recallBtn = document.createElement('button');
        recallBtn.className = 'recall-btn';
        recallBtn.innerHTML = 'æ’¤å›';
        recallBtn.title = 'æ’¤å›æ¶ˆæ¯';
        recallBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                recallMessage(message.id);
            }
        });
        
        // å°†æ’¤å›æŒ‰é’®æ·»åŠ åˆ°æ¶ˆæ¯å…ƒç´ ä¸­
        const contentDiv = messageEl.querySelector('.content');
        contentDiv.appendChild(recallBtn);
    }
    
    return messageEl;
};

// é…ç½®ç®¡ç†
const showSettings = () => {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            width: 400px;
        ">
            <h3>è®¾ç½®</h3>
            <div class="setting-group">
                <label for="ws-url">WebSocket URL:</label>
                <input type="text" id="ws-url" value="${state.config.wsUrl}" style="width: 100%;">
            </div>
            <div class="setting-group">
                <label for="api-url">API URL:</label>
                <input type="text" id="api-url" value="${state.config.apiUrl}" style="width: 100%;">
            </div>
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="auto-reconnect" checked> è‡ªåŠ¨é‡è¿
                </label>
            </div>
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="sound-notification" checked> å£°éŸ³é€šçŸ¥
                </label>
            </div>
            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                <button id="save-settings">ä¿å­˜</button>
                <button id="close-settings" class="secondary">å–æ¶ˆ</button>
            </div>
        </div>
    `;
    
    // æ·»åŠ å…³é—­åŠŸèƒ½
    const closeBtn = modal.querySelector('#close-settings');
    closeBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    // æ·»åŠ ä¿å­˜åŠŸèƒ½
    const saveBtn = modal.querySelector('#save-settings');
    saveBtn.addEventListener('click', () => {
        const wsUrl = document.getElementById('ws-url').value;
        const apiUrl = document.getElementById('api-url').value;
        const autoReconnect = document.getElementById('auto-reconnect').checked;
        const soundNotification = document.getElementById('sound-notification').checked;
        
        // ä¿å­˜è®¾ç½®
        state.config.wsUrl = wsUrl;
        state.config.apiUrl = apiUrl;
        
        try {
            localStorage.setItem('webchatqq_config', JSON.stringify({
                wsUrl, apiUrl, autoReconnect, soundNotification
            }));
        } catch (e) {
            console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', e);
        }
        
        addSystemMessage('è®¾ç½®å·²ä¿å­˜');
        document.body.removeChild(modal);
        
        // é‡æ–°è¿æ¥
        if (state.isConnected) {
            connect();
        }
    });
    
    document.body.appendChild(modal);
};

// åœ¨åˆå§‹åŒ–æ—¶åŠ è½½è®¾ç½®
const loadFromLocalStorage = () => {
    try {
        const savedUser = localStorage.getItem('webchatqq_user');
        const savedGroup = localStorage.getItem('webchatqq_group');
        const savedConfig = localStorage.getItem('webchatqq_config');
        
        if (savedUser) {
            state.currentUser = { ...state.currentUser, ...JSON.parse(savedUser) };
            elements.nickname.value = state.currentUser.nickname;
        }
        
        if (savedGroup) {
            state.currentGroup = { ...state.currentGroup, ...JSON.parse(savedGroup) };
            elements['group-id'].value = state.currentGroup.id;
        }
        
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            state.config = { ...state.config, ...config };
        }
    } catch (e) {
        console.error('åŠ è½½æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
    }
};

// æˆ³ä¸€æˆ³åŠŸèƒ½
const sendPoke = async (targetId) => {
    try {
        const response = await fetch(`${state.config.apiUrl}/send_msg`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message_type: 'group',
                group_id: parseInt(state.currentGroup.id),
                message: `[CQ:poke,qq=${targetId}]`
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'ok') {
            addSystemMessage(`æˆ³äº†æˆ³ ${targetId}`);
        } else {
            console.error('æˆ³ä¸€æˆ³å¤±è´¥:', result);
            addSystemMessage('æˆ³ä¸€æˆ³å¤±è´¥: ' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('å‘é€æˆ³ä¸€æˆ³æ—¶å‡ºé”™:', error);
        addSystemMessage('å‘é€æˆ³ä¸€æˆ³æ—¶å‡ºé”™: ' + error.message);
    }
};

// åœ¨æˆå‘˜åˆ—è¡¨é¡¹ä¸­æ·»åŠ æˆ³ä¸€æˆ³åŠŸèƒ½
const updateMemberList = (members) => {
    state.currentGroup.members = members;
    elements.memberList.innerHTML = '';
    
    members.forEach(member => {
        const li = document.createElement('li');
        li.innerHTML = `
            <div class="avatar">${utils.getInitials(member.nickname)}</div>
            <div class="member-info">
                <div class="member-name">${escapeHtml(member.nickname)}</div>
                ${member.title ? `<div class="member-title">${escapeHtml(member.title)}</div>` : ''}
            </div>
            <button class="poke-btn" title="æˆ³ä¸€æˆ³">ğŸ‘†</button>
        `;
        
        // æ·»åŠ æˆ³ä¸€æˆ³äº‹ä»¶
        const pokeBtn = li.querySelector('.poke-btn');
        pokeBtn.addEventListener('click', () => {
            sendPoke(member.user_id);
        });
        
        elements.memberList.appendChild(li);
    });
    
    elements.onlineCount.textContent = `åœ¨çº¿: ${members.length}`;
};

const setupEventListeners = () => {
    // ... å·²æœ‰çš„ç›‘å¬å™¨
    
    // å›¾ç‰‡ä¸Šä¼ æŒ‰é’®
    const imageUploadBtn = document.createElement('button');
    imageUploadBtn.id = 'image-upload-btn';
    imageUploadBtn.innerHTML = 'ğŸ“·';
    imageUploadBtn.title = 'ä¸Šä¼ å›¾ç‰‡';
    imageUploadBtn.style.marginRight = '0.5rem';
    imageUploadBtn.addEventListener('click', triggerImageUpload);
    
    elements.inputArea.insertBefore(imageUploadBtn, elements.messageInput);
    
    // éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.id = 'file-input';
    fileInput.style.display = 'none';
    fileInput.addEventListener('change', handleFileSelect);
    
    document.body.appendChild(fileInput);

    // è®¾ç½®æŒ‰é’®
    const settingsBtn = document.createElement('button');
    settingsBtn.id = 'settings-btn';
    settingsBtn.innerHTML = 'âš™ï¸';
    settingsBtn.title = 'è®¾ç½®';
    settingsBtn.style.marginLeft = 'auto';
    settingsBtn.addEventListener('click', showSettings);
    
    elements.chatHeader.appendChild(settingsBtn);
};

// è§¦å‘æ–‡ä»¶é€‰æ‹©
const triggerImageUpload = () => {
    document.getElementById('file-input').click();
};

// å¤„ç†æ–‡ä»¶é€‰æ‹©
const handleFileSelect = async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†
    event.target.value = '';
    
    if (!utils.isImageFile(file)) {
        addSystemMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        return;
    }
    
    // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
    addSystemMessage('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...');
    
    try {
        // ä¸Šä¼ å›¾ç‰‡
        const fileName = await utils.uploadImage(file, state.config.apiUrl);
        
        // å‘é€å›¾ç‰‡æ¶ˆæ¯
        const cqCode = utils.buildCQCode('image', { file: fileName });
        
        const response = await fetch(`${state.config.apiUrl}/send_msg`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message_type: 'group',
                group_id: parseInt(state.currentGroup.id),
                message: cqCode
            })
        });
        
        const result = await response.json();
        
        if (result.status !== 'ok') {
            throw new Error(result.msg || 'å‘é€å¤±è´¥');
        }
        
        addSystemMessage('å›¾ç‰‡å‘é€æˆåŠŸ');
    } catch (error) {
        console.error('å›¾ç‰‡ä¸Šä¼ æˆ–å‘é€å¤±è´¥:', error);
        addSystemMessage('å›¾ç‰‡ä¸Šä¼ æˆ–å‘é€å¤±è´¥: ' + error.message);
    }
};

// ä¸»åº”ç”¨
const app = createApp({
    setup() {
        // çŠ¶æ€ç®¡ç†
        const state = reactive({
            // è¿æ¥çŠ¶æ€
            isConnected: false,
            isConnecting: false,
            connectionError: null,
            
            // ç”¨æˆ·ä¿¡æ¯
            currentUser: {
                id: null,
                nickname: '',
                avatar: null
            },
            
            // ç¾¤ç»„ä¿¡æ¯
            currentGroup: {
                id: null,
                name: 'æœªçŸ¥ç¾¤ç»„',
                members: []
            },
            
            // æ¶ˆæ¯åˆ—è¡¨
            messages: [],
            
            // è¾“å…¥æ¡†å†…å®¹
            inputMessage: '',
            
            // WebSocket è¿æ¥
            ws: null,
            
            // é…ç½®
            config: {
                wsUrl: 'ws://localhost:18088',
                apiUrl: 'http://localhost:16099'
            }
        });
        
        // å¼•ç”¨DOMå…ƒç´ 
        const elements = {
            login: document.getElementById('login'),
            chat: document.getElementById('chat'),
            messages: document.getElementById('messages'),
            memberList: document.getElementById('member-list'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            joinButton: document.getElementById('join-button'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            onlineCount: document.getElementById('online-count'),
            sidebarToggle: document.getElementById('sidebar-toggle')
        };
        
        // åˆå§‹åŒ–
        onMounted(() => {
            // åŠ è½½æœ¬åœ°å­˜å‚¨çš„è®¾ç½®
            loadFromLocalStorage();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // å°è¯•è‡ªåŠ¨è¿æ¥ï¼ˆå¦‚æœæœ‰ä¿å­˜çš„ç¾¤ç»„ä¿¡æ¯ï¼‰
            if (state.currentGroup.id) {
                setTimeout(connect, 1000);
            }
        });
        
        // æ¸…ç†
        onUnmounted(() => {
            if (state.ws) {
                state.ws.close();
            }
        });
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        const loadFromLocalStorage = () => {
            try {
                const savedUser = localStorage.getItem('webchatqq_user');
                const savedGroup = localStorage.getItem('webchatqq_group');
                
                if (savedUser) {
                    state.currentUser = { ...state.currentUser, ...JSON.parse(savedUser) };
                    elements.nickname.value = state.currentUser.nickname;
                }
                
                if (savedGroup) {
                    state.currentGroup = { ...state.currentGroup, ...JSON.parse(savedGroup) };
                    elements['group-id'].value = state.currentGroup.id;
                }
            } catch (e) {
                console.error('åŠ è½½æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
            }
        };
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        const saveToLocalStorage = () => {
            try {
                localStorage.setItem('webchatqq_user', JSON.stringify({
                    nickname: state.currentUser.nickname
                }));
                
                localStorage.setItem('webchatqq_group', JSON.stringify({
                    id: state.currentGroup.id
                }));
            } catch (e) {
                console.error('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
            }
        };
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        const setupEventListeners = () => {
            // åŠ å…¥ç¾¤ç»„æŒ‰é’®
            elements.joinButton.addEventListener('click', joinGroup);
            
            // å‘é€æ¶ˆæ¯æŒ‰é’®å’Œå›è½¦é”®
            elements.sendButton.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // ä¾§è¾¹æ åˆ‡æ¢
            elements.sidebarToggle.addEventListener('click', () => {
                elements.sidebar.classList.toggle('hidden');
            });
            
            // çª—å£å…³é—­å‰æç¤º
            window.addEventListener('beforeunload', (e) => {
                if (state.isConnected) {
                    e.preventDefault();
                    e.returnValue = 'ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿæœªå‘é€çš„æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±ã€‚';
                }
            });
        };
        
        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        const updateConnectionStatus = (status, text) => {
            state.isConnected = status === 'connected';
            state.isConnecting = status === 'connecting';
            state.connectionError = status === 'error' ? text : null;
            
            elements.statusDot.className = 'status-dot ' + status;
            elements.statusText.textContent = 
                status === 'connected' ? 'å·²è¿æ¥' :
                status === 'connecting' ? 'è¿æ¥ä¸­...' :
                status === 'error' ? `é”™è¯¯: ${text}` : 'æœªè¿æ¥';
        };
        
        // è¿æ¥åˆ°WebSocket
        const connect = () => {
            if (state.ws) {
                state.ws.close();
            }
            
            updateConnectionStatus('connecting');
            
            try {
                state.ws = new WebSocket(state.config.wsUrl);
                
                state.ws.onopen = () => {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                    updateConnectionStatus('connected');
                    
                    // è¯·æ±‚ç¾¤æˆå‘˜åˆ—è¡¨
                    getGroupMemberList();
                };
                
                state.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', e, event.data);
                    }
                };
                
                state.ws.onclose = (event) => {
                    console.log('WebSocketè¿æ¥å·²å…³é—­', event.code, event.reason);
                    updateConnectionStatus('disconnected', `è¿æ¥å·²å…³é—­: ${event.code} ${event.reason}`);
                    
                    // å°è¯•é‡æ–°è¿æ¥
                    if (!event.wasClean) {
                        setTimeout(() => {
                            if (state.currentGroup.id) {
                                console.log('å°è¯•é‡æ–°è¿æ¥...');
                                connect();
                            }
                        }, 3000);
                    }
                };
                
                state.ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    updateConnectionStatus('error', 'è¿æ¥å¤±è´¥');
                };
            } catch (e) {
                console.error('åˆ›å»ºWebSocketè¿æ¥å¤±è´¥:', e);
                updateConnectionStatus('error', e.message);
            }
        };
        
        // å¤„ç†WebSocketæ¶ˆæ¯
        const handleWebSocketMessage = (data) => {
            // æ ¹æ®OneBotåè®®å¤„ç†ä¸åŒçš„äº‹ä»¶ç±»å‹
            switch (data.post_type) {
                case 'message':
                    handleMessageEvent(data);
                    break;
                    
                case 'notice':
                    handleNoticeEvent(data);
                    break;
                    
                case 'meta_event':
                    // å…ƒäº‹ä»¶ï¼Œå¦‚å¿ƒè·³ï¼Œé€šå¸¸å¯ä»¥å¿½ç•¥
                    break;
                    
                default:
                    console.log('æœªçŸ¥çš„äº‹ä»¶ç±»å‹:', data);
            }
        };
        
        // å¤„ç†æ¶ˆæ¯äº‹ä»¶
        const handleMessageEvent = (data) => {
            if (data.message_type === 'group' && data.group_id == state.currentGroup.id) {
                // è§£ææ¶ˆæ¯å†…å®¹
                const parsedMessage = utils.parseCQCode(data.message);
                
                // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
                const message = {
                    id: data.message_id || utils.generateId(),
                    type: 'groupMsg',
                    time: data.time * 1000, // è½¬æ¢ä¸ºæ¯«ç§’
                    sender: {
                        user_id: data.user_id,
                        nickname: data.sender.card || data.sender.nickname,
                        role: data.sender.role,
                        title: data.sender.title
                    },
                    message: parsedMessage,
                    raw: data
                };
                
                // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
                addMessage(message);
            }
        };
        
        // å¤„ç†é€šçŸ¥äº‹ä»¶
        const handleNoticeEvent = (data) => {
            switch (data.notice_type) {
                case 'group_increase':
                    // æ–°æˆå‘˜åŠ å…¥
                    if (data.group_id == state.currentGroup.id) {
                        addSystemMessage(`æ¬¢è¿ ${data.user_id} åŠ å…¥ç¾¤èŠ`);
                        // æ›´æ–°æˆå‘˜åˆ—è¡¨
                        getGroupMemberList();
                    }
                    break;
                    
                case 'group_decrease':
                    // æˆå‘˜ç¦»å¼€
                    if (data.group_id == state.currentGroup.id) {
                        const operator = data.operator_id ? ` (ç”± ${data.operator_id} æ“ä½œ)` : '';
                        addSystemMessage(`${data.user_id} ç¦»å¼€äº†ç¾¤èŠ${operator}`);
                        // æ›´æ–°æˆå‘˜åˆ—è¡¨
                        getGroupMemberList();
                    }
                    break;
                    
                case 'group_ban':
                    // ç¦è¨€äº‹ä»¶
                    if (data.group_id == state.currentGroup.id) {
                        const duration = data.duration ? ` ${data.duration}ç§’` : '';
                        const action = data.sub_type === 'ban' ? 'ç¦è¨€' : 'è§£é™¤ç¦è¨€';
                        addSystemMessage(`${data.operator_id} ${action}äº† ${data.user_id}${duration}`);
                    }
                    break;
                    
                default:
                    console.log('æœªçŸ¥çš„é€šçŸ¥ç±»å‹:', data);
            }
        };
        
        // æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡¨
        const addMessage = (message) => {
            state.messages.push(message);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                elements.messages.scrollTop = elements.messages.scrollHeight;
            }, 100);
        };
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        const addSystemMessage = (text) => {
            const message = {
                id: utils.generateId(),
                type: 'system',
                time: Date.now(),
                message: [{ type: 'text', data: { text } }]
            };
            
            addMessage(message);
        };
        
        // æ¸²æŸ“æ¶ˆæ¯
        const renderMessage = (message) => {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${message.sender && message.sender.user_id === state.currentUser.id ? 'self' : ''}`;
            messageEl.dataset.id = message.id;
            
            if (message.type === 'system') {
                // ç³»ç»Ÿæ¶ˆæ¯
                messageEl.className = 'system-message';
                messageEl.textContent = message.message[0].data.text;
                return messageEl;
            }
            
            // ç”¨æˆ·æ¶ˆæ¯
            let html = `
                <div class="avatar">${utils.getInitials(message.sender.nickname)}</div>
                <div class="content">
                    <div class="sender">
                        ${escapeHtml(message.sender.nickname)}
                        ${message.sender.title ? `<span class="badge">${escapeHtml(message.sender.title)}</span>` : ''}
                        <span class="time">${utils.formatTime(message.time)}</span>
                    </div>
                    <div class="text">
            `;
            
            // æ¸²æŸ“æ¶ˆæ¯å†…å®¹
            message.message.forEach(part => {
                if (part.type === 'text') {
                    html += escapeHtml(part.data.text).replace(/\n/g, '<br>');
                } else if (part.type === 'image') {
                    html += `<img src="${part.data.url || part.data.file}" class="message-image" alt="å›¾ç‰‡" loading="lazy">`;
                } else if (part.type === 'face') {
                    html += `<span class="face">[è¡¨æƒ…${part.data.id}]</span>`;
                } else {
                    html += `[${part.type}]`;
                }
            });
            
            html += `
                    </div>
                </div>
            `;
            
            messageEl.innerHTML = html;
            
            // æ·»åŠ å›¾ç‰‡ç‚¹å‡»æŸ¥çœ‹åŠŸèƒ½
            const images = messageEl.querySelectorAll('.message-image');
            images.forEach(img => {
                img.addEventListener('click', () => {
                    showImageModal(img.src);
                });
            });
            
            return messageEl;
        };
        
        // æ›´æ–°æ¶ˆæ¯æ˜¾ç¤º
        const updateMessagesDisplay = () => {
            // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
            elements.messages.innerHTML = '';
            
            // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
            state.messages.forEach(message => {
                elements.messages.appendChild(renderMessage(message));
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            elements.messages.scrollTop = elements.messages.scrollHeight;
        };
        
        // æ˜¾ç¤ºå›¾ç‰‡æ¨¡æ€æ¡†
        const showImageModal = (src) => {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="max-width: 90%; max-height: 90%;">
                    <img src="${src}" style="max-width: 100%; max-height: 100%;">
                </div>
                <button style="
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: #fff;
                    border: none;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    font-size: 20px;
                    cursor: pointer;
                ">Ã—</button>
            `;
            
            // æ·»åŠ å…³é—­åŠŸèƒ½
            const closeBtn = modal.querySelector('button');
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            document.body.appendChild(modal);
        };
        
        // æ›´æ–°æˆå‘˜åˆ—è¡¨
        const updateMemberList = (members) => {
            state.currentGroup.members = members;
            elements.memberList.innerHTML = '';
            
            members.forEach(member => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="avatar">${utils.getInitials(member.nickname)}</div>
                    <div class="member-info">
                        <div class="member-name">${escapeHtml(member.nickname)}</div>
                        ${member.title ? `<div class="member-title">${escapeHtml(member.title)}</div>` : ''}
                    </div>
                `;
                elements.memberList.appendChild(li);
            });
            
            elements.onlineCount.textContent = `åœ¨çº¿: ${members.length}`;
        };
        
        // åŠ å…¥ç¾¤ç»„
        const joinGroup = () => {
            const nickname = elements.nickname.value.trim();
            const groupId = elements['group-id'].value.trim();
            const password = elements.password.value.trim();
            
            if (!nickname) {
                alert('è¯·è¾“å…¥æ˜µç§°');
                return;
            }
            
            if (!groupId) {
                alert('è¯·è¾“å…¥ç¾¤å·');
                return;
            }
            
            // ä¿å­˜ç”¨æˆ·å’Œç¾¤ç»„ä¿¡æ¯
            state.currentUser.nickname = nickname;
            state.currentUser.id = utils.generateId();
            state.currentGroup.id = groupId;
            
            saveToLocalStorage();
            
            // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
            elements.login.classList.add('hidden');
            elements.chat.classList.remove('hidden');
            
            // è®¾ç½®ç¾¤ç»„åç§°ï¼ˆæš‚æ—¶ä½¿ç”¨ç¾¤å·ï¼Œåé¢å¯ä»¥ä»APIè·å–ï¼‰
            document.querySelector('#chat-header h3').textContent = `ç¾¤èŠ ${groupId}`;
            
            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            addSystemMessage('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...');
            
            // è¿æ¥åˆ°WebSocket
            connect();
        };
        
        // å‘é€æ¶ˆæ¯
        const sendMessage = async () => {
            const text = elements.messageInput.value.trim();
            if (!text || !state.isConnected) return;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            elements.messageInput.value = '';
            
            try {
                // è°ƒç”¨go-cqhttpçš„APIå‘é€æ¶ˆæ¯
                const response = await fetch(`${state.config.apiUrl}/send_msg`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message_type: 'group',
                        group_id: parseInt(state.currentGroup.id),
                        message: text
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'ok') {
                    console.log('æ¶ˆæ¯å‘é€æˆåŠŸ');
                } else {
                    console.error('æ¶ˆæ¯å‘é€å¤±è´¥:', result);
                    addSystemMessage('æ¶ˆæ¯å‘é€å¤±è´¥: ' + (result.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯æ—¶å‡ºé”™:', error);
                addSystemMessage('å‘é€æ¶ˆæ¯æ—¶å‡ºé”™: ' + error.message);
            }
        };
        
        // è·å–ç¾¤æˆå‘˜åˆ—è¡¨
        const getGroupMemberList = async () => {
            try {
                const response = await fetch(`${state.config.apiUrl}/get_group_member_list?group_id=${state.currentGroup.id}`);
                const result = await response.json();
                
                if (result.status === 'ok') {
                    // å¤„ç†æˆå‘˜æ•°æ®
                    const members = result.data.map(member => ({
                        user_id: member.user_id,
                        nickname: member.card || member.nickname,
                        role: member.role,
                        title: member.title
                    }));
                    
                    updateMemberList(members);
                } else {
                    console.error('è·å–æˆå‘˜åˆ—è¡¨å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('è·å–æˆå‘˜åˆ—è¡¨æ—¶å‡ºé”™:', error);
            }
        };
        
        // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        // å“åº”å¼æ›´æ–°æ¶ˆæ¯æ˜¾ç¤º
        Vue.watchEffect(() => {
            if (state.messages.length > 0) {
                updateMessagesDisplay();
            }
        });
        
        return {
            state,
            joinGroup,
            sendMessage
        };
    }
}).mount('#app');
    </script>
</body>
</html>